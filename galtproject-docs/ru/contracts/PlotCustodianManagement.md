# Контракт PlotCustodianManagement

## Описание проблемы
Нужно создать ликвидный производный инструмент для крипто-инвесторов, обеспеченные земельными активами.  Сделать так, чтобы передавать токен можно было без изменений права собственности на землю в государственном реестре, но при этом права владельцев токенов были защищены. Сделать так, чтобы под землю можно было выпустить ERC20 токен.

## Цели контракта
- Регистрация Кастодиана по земельному участку за комиссию.

## Особенности выплаты вознаграждений
Выплата вознаграждений имеет следующую структуру(соотношение верхнего уровня задано в самом контракте):
* GaltSpace - идет на контракт распределения вознаграждений
* Oracles - распределяется между ораклами, соотношение между ролями задано в контракте `Oracles`
  * Custodians - распределяется равными частями между всеми валидаторами (как изменяемыми, так и существующими). Если адрес присутствует как в изменяемых так и в существующих, учитывается только одна из групп.
  * Auditor - распределяется единственному аудитору

## Ограничение
* Максимальное кол-во привязанных к SPACE токену кастодианов - 10 шт.

## Роли заявки
Роли заявки жестко прописаны в контракте PlotValuation. Список ролей в контракте Validators должен четко ему соответствовать

* `PC_CUSTODIAN_ROLE` - Кастодиан (n <= 10)
* `PC_AUDITOR_ROLE` - Аудитор (1)

# Содержание заявки

* ID токена упаковки
* Список адресов выбрарнных пользователем кастодианов
* Действие:
  * ATTACH - привязать кастодиана
  * DETACH - отвязать кастодиана

# Действия заявки
## ATTACH
К участку можно привязать одного или несколько (до 10 шт.) кастодианов.

## DETACH
От участка можно отвязать несколько или сразу всех кастодианов.

# Распределение вознаграждения
* Galt Space - фиксированный процент, заданный владельцем контракта
* Аудитор - фиксированный процент, заданный владельцем контракта
* Кастодианы - фиксированный процент распределяется между всеми учавствующими кастодианами равными долями

# Статусы
## Статусы заявок

* `SUBMITTED` - новая заявка, сразу после создания готова для блокировки указанным в ней кастодианом
* `ACCEPTED` - кастодианы из списка изменения соглашаются на это изменение
* `REVERTED` - кастодиан не принял заявку в работу
* `LOCKED` - кастодиан готов работать над заявкой
* `REVIEW` - кастодиан работает над заявкой (переведен токен от заявителя)
* `APPROVED` - одобрена
* `COMPLETED` - выполнена (токен переведен обратно заявителю)
* `REJECTED` - не одобрена
* `CLOSED` - закрыта без модификации статуса кастодиана (токен переведен обратно заявителю)

# Статусы кастодианов
* `LOCKED` - уже существующий или добавляемый кастодиан
* `APPROVED` - уже существующий кастодиан или кастодиан из списка
* `REJECTED` - уже существующий кастодиан или кастодиан из списка

# Статусы ролей (только для аудитора)

* `LOCKED` - аудитор заблокировал сделку
* `APPROVED` - аудитор одобрил сделку
* `REJECTED` - аудитор не одобрил сделку

![Application Status List](../../images/PlotCustodianManager.png?raw=true "Application Status List")

# Интерфейс для владельца контракта
Владелец контракта может:

* Изменить минимальный размер комиссии в ETH
* Изменить минимальный размер комиссии в GALT
* Изменить долю комиссии, распределяемой в пользу GaltSpace в ETH (остаток распределяется в пользу валидаторов)
* Изменить долю комиссии, распределяемой в пользу GaltSpace в GALT (остаток распределяется в пользу валидаторов)
* Установить, какой из способов оплаты сейчас принимается (никакой, GALT, ETH, GALT И ETH)
* Установить адрес выплат комиссий от огранизации GaltSpace
* Остановить/Возобновить работу контракта (напр. в случае подозрения на наличие уязвимости)

#### #resetApplicationRole()
Владелец контракта может снять конкретного валидатора с роли в заявке
* Метод возможен только для заявок в статусе LOCKED

#### #claimGaltSpaceReward()
Владелец контракта забирает свою долю комиссии, оплаченную заявителем
* Метод возможен только для заявок в статусе COMPLETED либо CLOSED
* В зависимости от выбранной валюты, на адрес, указанный владельцем контракта, перечисляются либо ETH либо GALT

## Интерфейс для заявителя

#### #submit()
Заявитель подает заявку на регистрацию токена упаковки у кастодиана
* Указывается id SPACE токена
* Указывается список адресов кастодианов
* Указывается действие - привязать или отвязать список
* Выполняется порверка, что все указанные адреса в действительности имеют назначенную роль PC_CUSTODIAN
* Оплачивается комиссия в ETH или GALT
* В зависимости от поступившей оплаты, рассчитываются вознаграждения уже существующих валидаторов, аудитором и Galt Space
* Назначается статус заявки SUBMITTED

#### #resubmit()
Заявитель повторно подает заявку, возможно, с измененными данными
* Статус заявки должен быть REVERTED
* Статус заявки меняется на SUBMITTED

#### #attachToken()
Заявитель переводит токен упаковки на контракт
* Статус заявки должен быть LOCKED
* Происходит проверка, что именно этот токен был ранее указан в заявке
* Статус заявки меняется на REVIEW

#### #withdrawToken()
Заявитель выводит токен с контракта
* Статус заявки должен быть APPROVED
* Статус заявки меняется на COMPLETED

#### #close()
Заявитель закрывает незавершенную заявку либо заявку в статусе отказа

* Статус заявки должен быть LOCKED или REJECTED
* Если статус заявки REJECTED, то токен упаковки переходит обратно к заявителю
* Статус заявки меняется не CLOSED


## Интерфейс для кастодианов
#### #accept()
Кастодианы из списка на `добавление` и текущие кастодианы подтверждают свое согласие на работу над заявкой

* Статус заявки должен быть SUBMITTED
* Статус кастодиана устанавливается в LOCKED
* Статус заявки меняется на LOCKED, если все кастодианы (из списка и текущие) перевели свой статус в LOCKED

#### #revert()
Кастодиан (как из новых предложенных, так и из сущетсвующих) не соглашается на предложенные изменения над заявкой

* Статус заявки должен быть SUBMITTED
* Статус заявки меняется на REVERTED
* Сбрасываются все голоса как кандидатов на изменения так и существующих кастодианов

#### #attachDocuments()
Любой из кастодианов устанавливает массив хешей IPFS документов

* Статус заявки должен быть REVIEW
* Статус заявки не меняется
* Сбрасываются все голоса кастодианов, аудиатора и заявителя
* Каждый вызов метода перезаписывает массив документов, прикрепленный к заявке
* Каждый вызов метода сбрасывает все проголосовавшие за роли (изменяемые/текущи кастодианы, аудитор, пользователь) - необходимо голосовать заново

#### #lock()
Аудитор блокирует за собой право работы над заявкой

* Статус заявки должен быть REVIEW
* Статус роли аудитора меняется на LOCKED
* Статус заявки не меняется

#### #approve()
Кастодианы(изменяемые и текущие), заявитель и аудитор одобряет заявку.

* Статус заявки должен быть REVIEW
* Каждый участник этих 3 групп должен вызвать этот метод
* Если кастодиан находится и в изменяемых и в сущесвтующих (при удалении, он вызывает метод один раз)
* В зависимости от типа действия, кастодианы либо добавляются либо отвязываются от токена.
* Статус заявки меняется на APPROVED

#### #reject()
Любой кастодиан(изменяемый или текущий) и аудитор не одобряют заявку

## Интерфейс для аудитора
#### #lockAuditor()
Аудитор блокирует за собой работу над заявкой

* Статус заявки должен быть REVIEW
* Статус заявки не меняется
* Статус роли меняется на LOCKED

## Общий интерфейс для кастодианов и аудиторов
#### #rejectApplication()
Любой из кастодианов или аудитор не одобряет заявку

* Статус заявки должен быть REVIEW
* Статус заявки меняется на REJECTED

#### #approve()
Аудитор, заявитель или кастодиан одобряют изменение

* Статус заявки должен быть REVIEW
* В зависимости от типа действия, кастодиан(ы) либо привязывается либо отвязывается от токена.
* Статус заявки меняется на APPROVED только после того, как все участники
 (аудитор, все кастодианы и заявитель) вызвали этот метод

#### #claimOracleReward()
Валидатор забирает свое вознаграждение

* Статус заявки должен быть COMPLETED либо CLOSED
* В зависимости от типа заявки, на адрес оракла перечисляются либо ETH либо GALT
* Поставляется флаг, что оракул на данной роли получил вознаграждение
* Статус заявки не изменяется

## Сценарий UI 1: Регистрация токена земельного участка у Кастодиана
1. Если оценка земельного участка выполнена, то возможна регистрация земельного участка у Кастодиана. Регистрация предполагает переход права собственности на участок к Кастодиану с обязательством вернуть это право держателю SPACE токена.
2. В меню земельного участка доступна кнопку "Зарегистрировать участок у Кастодиана".
3. Появляются поля для ввода данных.

|Параметр|Значение по умолчанию|Тип|
|--------|--------|---------|
|ID Участка|Берется по выбранному участку, не редактируется|uint256|
|Селектор оплаты комиссии|GALT, меняется на ETH|Селектор|
|Поле для ввода комиссии|Минимальное значение комиссии|float|
|Рекомендуемая комиссия|Рассчитанная рекомендуемая комиссия|float|
|Кастодиан|Пусто, при нажатии отображается список допустимых Кастодианов с их отображанием на карте с описанием|Адрес|

4. Пользователь нажимает "Подтвердить" и создается транзакция с вызовом метода по созданию заявки.

5. Кастодиан в меню "Мои заявки на регистрацию прав" видит все заявки, которые были назначены ему. Он нажимает кнопку "Принять заявку". Заявка меняет статус на принята. Если Кастодиан нажимает отклонить заявку, то он возвращается Пользователю и пользователь может выбрать другого Кастодиана. Кастодиан должен указать причину отклонения заявки.

6. Пользователь, если заявка принята Кастодианом нажимает кнопку - "Отправить токен на контракт Регистрации". Создается транзакция, статус заявки меняется. Создается новый контракт, на который передется токен участка. Для вывода токена участка с контракта необходимо 3 подписи: Пользователя, Кастодиана и Аудитора. Оплачивается комиссия.

7. Кастодиан офчейн готовит все необходимые документы. Пользователь встречается с Кастодианом, подписывает все необходимые документы. Кастодиан выполняет регистрационные действия и после того, как они выполнены нажимает в меню заявки кнопку "Загрузить документы". Кастодиан загружает документы и подписывает транзакцию с сохранением документов в IPFS, а хеша в заявки и в контракте, на котором находится токен Участка.

8. После этого Пользователь, Кастодиан и Аудитор должны выполнить транзакцию, которая изменит статус заявки и передаст токен участка с контракта обратно пользователю. При этом Адрес Кастодиана будет зафиксирован в контракте.

## Сценарий UI 2: Отправка токена участка на DEX
1. После этого пользователь может отправить токен на DEX и получить токены GALT, которые были определены последней оценкой.

## Риски
* Даже при условии, что есть проблемы с присвоением кастодиана, все должны согласиться и присвоить его. По другому токен упаковки с контракта не вывести.
