# Контракт Аукцион земли - Требования

* Epic issue https://github.com/andromedaspace/WIJG/issues/363
* UI Mindmap https://mm.tt/1116945428?t=Ko5NjQKJPi

## Описание проблемы
Необходимо обеспечить первичную продажу по максимально честной цене и выпуск SPACE токенов с условием того, что на аукцион переданы SPACE токены Территории, которые определяют допустимую область земли, на которой можно через аукцион приобрести дочерние SPACE токены. Таким образом нужно чтобы аукцион позволял сделать ставку на ещё не выпущенный SPACE токен, но в разрешенной Территории, чтобы после всех проверок был создан новый токен SPACE и запущен на него аукцион.

## Цели контракта
- SPACE токены нужно продавать на аукционе по максимально честной цене избежав недостатки традиционного аукциона, когда опоненты перебивают ставки по минимальному увеличению цены.
- Необходимо реализовать аукцион земли базируясь на абстрактном классе [Аукциона Викри](Аукцион-Викри.md) со всеми его требованиями.
- Дать возможность пользователям самим выбирать какой они хотят купить геохеш из доступной области на аукционе.
- Избежать ситуации когда пользователи покупают родительские геохеши с наибольшей площадью участков и на этом аукцион первичной продажи заканчивается.
- при деплое контракта должна быть возможность ограничить список участков, которые могут быть проданы на аукционе. Это нужно, когда Владелец земли или Оператор ввода хочет передать ее с начальным межеванием.

## Входные данные

|Параметр|Контракт|
|-------|--------|
|id заявки на ввод Территории|Контракт SPACEAuctionRegistry|
|Максимальный размер участка на аукционе по id заявки на ввод Территории|Контракт CreateTerritory|
|Минимальный размер участка на аукционе id заявки на ввод Территории|Контракт CreateTerritory|
|Минимальная ставка для минимального размера участка в GALT |Контракт CreateTerritory|

## Основные требования:
- Аукцион должен выпускать SPACE токены после проверки, что токен можно купить и после первой ставки, т.е. после создания лота на аукционе.
- Минимальная цена на геохеш должна определяться величиной области участка геохеша: чем больше область - тем больше цена.
- На первичном аукционе должны быть только геохеши тех размерностей, который были указаны в Заявке на ввод Территории.
- При вторичной продаже SPACE токена - необходимо обеспечить стандартную работу аукциона без возможности выпуска нового дочернего токена.
- Минимальная цена лота при повторном выставлении токена будет такой же, как при первичном.
- Для повторных лотов правила по минимальному и максимальному размеру участка не действуют.
- Победитель лота аукциона получает во владение SPACE токен.

## Сценарий контракта
### Сценарий 1: Первичная продажа SPACE токена
1. При запуске контракта из контракта GaltGenesis контракт SpaceAuction запрашивает по id заявки на ввод Территории следующие параметры из контракта CreateTerritory: Максимальный размер участка на аукционе по id заявки на ввод Территории, Минимальный размер участка на аукционе id заявки на ввод Территории, Минимальная ставка для минимального размера участка в GALT. Контракт записывает эти параметры себе для дальнейшего использования.

|Параметр|Значение|
|-------|--------|
|Геохеш|sezu0123|
|Максимальный размер участка|8|
|Минимальный размер участка|6|
|Минимальная ставка для минимального размера|500|

2. Пользователь находит информацию о том, какие родительские хеши выставлены на аукционе или каки уникальные участки.
3. Пользователь 2 выбирает какой из дочерних геохешей или уникальных участков он хочет приобрести.
4. Пользователь отправляет Заявку на лот. В заявке на лот он указывает: Геохеш участка или id уникального участка, который хочет купить, открытую ставку, закрытую ставку в токенах GALT. Открытая ставка в токенах GALT отправляется контракту SPACEAuction.

|Параметр|Значение|
|-------|--------|
|Геохеш|sezu0123|
|Открытая ставка|1000|
|Закрытая ставка|900|

5. Контракт SpaceAuction делает проверку допустимости лота:

5.1 Если SPACEPermissionList не пуст, то контракт проверяет есть ли там геохеш или id уникального участка. Если нет - отказ.

5.1. Контракт проверяет, что геохеш допустимого разряда. Если да, то 3.2., если нет - то отказ. В нашем примере 8 = 8 и разряд допустим. Сделать проверку на то, что минимальная открытая ставка не меньше минимальной ставки.

5.2. Контракт убирает один разряд от переданного геохеша. 

|Параметр|Значение|
|-------|--------|
|Геохеш|sezu0123|
|Родительский Геохеш|sezu012|

5.3. Контракт проверяет есть ли Родительский SPACE токен с таким ID в контракте SPACEToken. 
Если Родительский SPACE токен есть, то 3.4. Иначе 3.5. 

5.4. В этом случае возможны следуюшие варианты:

5.4.1. Родительский SPACE токен является Токеном Территории и принадлежит SPACEAuctionRegistry.  

5.4.1.1. Если массив временных геохешей пуст, то SPACEAuctionRegistry выпускает токен SPACE на Геохеш, владелец токена SpaceAuction. И в этом случае создается Лот аукциона. Происходит переход к 3.7. 

5.4.1.2. Если массив временных родительских геохешей не пуст, то выпустить на каждый геохеш из массива токен  SPACE, владелец - контракт SplitMerge И SPACEAuctionRegistry выпускает токен SPACE на Геохеш, владелец токена SpaceAuction. И в этом случае создается Лот аукциона. Происходит переход к 3.7.

5.4.1.3. Если токен НЕ принадлежит SpaceAuction ИЛИ SPACEAuctionRegistry ИЛИ SplitMerge - отказ.

5.4.2. Родительский SPACE токен принадлежит пользователю. В этом случае транзакция отклоняется.

5.4.3. Родительский SPACE токен принадлежит контракту SplitMerge и является техническим токеном Земельного участка. В этом случае открывается Лот.

5.4.4. Родительский SPACE токен принадлежит SpaceAuction и это значит, что на Земельный участок открыт лот. В этом случае ставка пользователя принимается.

5.5. Записать Временный Родительский Геохеш. 

5.6. Отбросить разряд от Временного родительского геохеша и вернуться в 3.3.

5.7. Открыт Лот аукциона на конкретный токен SPACE с ID sezu0123 c открытой ставкой 1000 и закрытой ставкой 900. 

6. Пользователь №2 делает ставку на тот-же геохеш: 700 GALT публичной ставки и 600 GALT секретной ставки
![image](https://user-images.githubusercontent.com/4842007/41902701-6114264a-7934-11e8-83f0-30d647966d43.png)

7. После окончания периода действия аукциона на этот лот - любой пользователь вызывает функцию finishAuction. 

8. Пользователь с максимальной закрытой ставкой выиграывает. У нас это пользователь №1 со ставкой 900 GALT. Пользователь №1 получает разницу между своей открытой ставкой в 1000 GALT и закрытой ставкой Пользователя №2 (это 600 GALT). В итоге Пользователь №1 получает 1000 - 600 = 400 GALT.

9. Пользователь №2 проиграл аукцион и получает обратно свою Открытую ставку 700 GALT.

10. Контракт SPACEAuction передает SPACE токен пользователю №1. Контракт SPACEAuctionRegistry определяет по id заявки на создание территории Фонд из заявки. Контракт SPACEAuctionRegistry передает токены GALT выигравшие лот во владение Фонду, Контракт SPACEAuctionRegistry назначет пользователю - владельцу токена Репутацию в этом фонде в размере выигравшей ставки.

11. Далее - контракты Reputation, DelegateVoting, DelegateCandidateAuction, FundRegistry, MultiSigProposal, MultiSig, FundEthReplenish, Emission, SplitMerge.

#### Пример проверки допустимости геохеша на примере заявки на геохеш sezu0123. Токен Территории имеет адрес sezu.
1. Проверяем, что есть токен sezu0123. Токена нет - 2. Токен есть - отказ от выполнения.
2. Отбрасываем последний разряд. Получаем sezu012. Проверяем, что есть токен sezu012. Токена нет - 3. 
3. Записываем sezu012, отбрасываем 2 и получаем sezu01. Проверяем, что есть токен sezu01. Токена нет - 4.
4. Записываем sezu01, отбрасываем 1, получаем sezu0. Проверяем, что есть токен sezu0. Токена нет - 5.
5. Записываем sezu0, отбрасываем 0, получаем sezu. Проверяем, что есть токен sezu. Токен есть - 6.
6. Проверяем, кому принадлежит токен sezu. Токен принадлежит SPACEAuctionRegistry и это Токен Территории.
7. Создать токены sezu012, sezu01, sezu0 и назначить владельцем SplitMerge.
8. Создать токен sezu0123 и назначить владельцем SpaceAuction. Запустить лот аукцина на sezu0123.
9. Делаем заявку на новый лот на sezu02. Проверяем, что токен sezu02 есть, токена нет - 10.
10. Отбрасываем 2, получаем sezu0. Проверяем, что токен sezu0 есть. Токен есть - 11.
11. Проверяем, кому принадлежит токен sezu0. Токен принадлежит SplitMerge. То - 12.
12. Отбрасываем 0, получаем sezu, проверяем, что sezu есть. Токен - есть. Тогда - 13.
13. Проверяем, кому принадлежит sezu. Токен принадлежит SPACEAuctionRegistry и это Токен Территории. Тогда - 14.
14. Создать токен sezu02 и назначить владельцем SpaceAuction. Запустить лот аукцина на sezu02.
15. При любой проверке, если токен НЕ принадлежит SpaceAuction ИЛИ SPACEAuctionRegistry ИЛИ SplitMerge - отказ.

## Спецификация контракта
- Название класса: SpaceAuction
- Наследуется от абстрактного класса [Аукциона Викри](Аукцион-Викри.md)
- Добавлена связь с токеном SPACE для проверки наличия у продавца SPACE токена и передачи SPACE токена при успешной продаже
- Добавляется право на создание SPACE токенов, геохеши которых являются дочерними к тем, чтобы были выложены на аукцион

## Структуры данных 
### Маппинг допустимых участков - SPACEPermissionList
Маппинг <id space токена> - флаг доступности.

## Неоднозначные вопросы и ответы на них
### Как сделать так, чтобы один адрес не мог выиграть Аукцион на очень большую территорию?
Описание проблемы: Должен быть предусмотрен гибкитй механизм, который позволит распределить землю между оптимальным количеством владельцев. Не должно быть пользователей, которые смогут получить в собственность слишком большое количество земли дешево, так как это создаст дисбаланс в экономике.
#### Вариант №1
Можно ввести минимальное значение ставки для каждой разрядности Геохеша.

|Плюсы|Минусы|
|-----|-------|
|Полностью рыночное регулирование ограничения|Сложно решить заранее, какая минимальная ставки решит проблему. Можно ошибиться.|

#### Вариант №2
Ввести минимальный и максимальный размер геохеша для аукциона. Не использовать разные минимальные ставки. Любой разряд геохеша стоит одинаково.

|Плюсы|Минусы|
|-----|-------|
|Позволит сделать "Защиту от дурака" на случай ошибки с выбором ставок|Участки разного размера с разным разрядом будут на начальном этапе иметь одинаковую начальную цену. Это перекос. Можно будет в рамках разрешенного для продажи диапазона купить большой участок дешево.|

#### Вариант №3
Использовать оба варианта.

|Плюсы|Минусы|
|-----|-------|
|Позволит сделать "Защиту от дурака" на случай ошибки с выбором ставок| Не решает идеально проблему. Начальная ставка на большой участок пустыни будет в десятки раз выше начальной ставки на небольшой участок с низким залеганием грунтовых вод. Хотя второй реально должен стоить больше. Хотя, вероятно, это выровняет аукцион.|

### Какая минимальная ставка для какой разрядности Геохеша допустима и как ее определить?
Нужно все взвесить.
### Как обеспечить гармоничное развитие территории с точки зрения плотности проживания?
Описание проблемы: Если любой человек сможет купить землю в любом месте, то на начальном этапе мы получим большое количество землевладений, расположенных на большом удалении друг от друга. В таком случае им вместе сложно будет развиваться из-за удаленности друг от друга. Компактность проживания дает большие преимущества для экономических связей, безопасности и комфорта. Нам нужно заложить механизм, который позволит сделать так, что люди покупали землю друг с другом.
Решение:
- Заложить токены участков, которые не будут никому принадлежать и станут "начальными точками роста". Начальные точки роста можно задать исходя из ресурсов и привлекательности конкретной области;
- Участок землю можно будет купить на аукционе только в том случае, если он граничит с начальной точкой роста или соседний участок уже продан;
Формальное описание решения:
- Добавить проверку "соседний участок" = начальная точка роста ИЛИ "соседний участок" - продан.
### Как сделать так, чтобы не продать всю землю сразу?
Описание проблемы: Скорость продажи земли должна быть согласована со скоростью экономического развития территории и привлечением дополнительных Эфиров в Фонд. Если вся земля будет получена пользователями в результате аукционов слишком быстро и дешево, то это значительно снизит возможные темпы развития экономики территории, так как уменьшить объем привлечения новых средств в Фонд. Смысла получать GALT на Аукционе Эмиссии будет меньше, если не будет свободной земли, которую можно выиграть.
Возможные решения:
- Сделать сроки проведения аукционов динамическими. Подумать от каких параметров они могут зависеть.

## Особенности реализации на TypeScript
- На TypeScript сейчас реализована простейшая продажа отдельных участков земли, выкладываемых в рамках деплоя на аукцион.
Нет логики доступных областей, есть только выложенные участки на аукцион для их прямой продажи.
- Также при покупке земли не указывается в какой фонд будет передан залог, залог всегда передается в 0 фонд.
