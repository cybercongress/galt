# PlotValuation

## Цель контракта 

* Возможность оценить стоимость земельного участка в токенах GALT с целью получения залога.

## Роли заявки
Роли валидаторов, используемые в заявках, жестко прописаны в контракте PlotValuation.
Список ролей в контракте Validators, который задается вручную, должен четко ему соответствовать

* `PV_APPRAISER_ROLE` - Оценщик
* `PV_APPRAISER2_ROLE` - Контролер-оценщик
* `PV_AUDITOR_ROLE` - Аудитор

## Содержание заявки
* ID токена упаковки
* Список хешей прилагаемых документов из IPFS. Задается только один раз и не может быть модифицирован.

## Статусы заявок
* `SUBMITTED` - новая заявка, сразу после создания готова к рассмотрению валидаторами
* `VALUATED` - оценена первым оценщиком
* `CONFIRMED` - подтверждена вторым оценщиком
* `REVERTED` - не подтверждена вторым оценщиком
* `APPROVED` - подтверждена аудитором

![Application Status List](../../images/PlotValuation.png?raw=true "Application Status List")

## Статусы ролей
* `PENDING` - ожидает блокировки валидаторов с данной ролью
* `LOCKED` - заблокирована валидатором с данной ролью

## Интерфейс для владельца контракта
Владелец контракта может:
* Изменить минимальный размер комиссии в ETH
* Изменить минимальный размер комиссии в GALT
* Изменить долю комиссии, распределяемой в пользу GaltSpace в ETH (остаток распределяется в пользу валидаторов)
* Изменить долю комиссии, распределяемой в пользу GaltSpace в GALT (остаток распределяется в пользу валидаторов)
* Установить, какой из способов оплаты сейчас принимается (никакой, GALT, ETH, GALT И ETH)
* Установить адрес выплат комиссий от огранизации GaltSpace
* Остановить/Возобновить работу контракта (напр. в случае подозрения на наличие уязвимости)

#### #resetApplicationRole()
Владелец контракта может снять конкретного валидатора с роли в заявке

* Метод возможен для
    * Всех статусов заявки кроме APPROVED/NOT_EXISTS
    * Ролей в статусе LOCKED

#### #claimGaltSpaceReward()
Владелец контракта забирает свою долю комиссии, оплаченную заявителем

* Метод возможен только для заявок в статусе APPROVED
* В зависимости от выбранной валюты, на адрес, указанный владельцем контракта, перечисляются либо ETH либо GALT

## Интерфейс для заявителя
#### #submitApplication()
Заявитель подает заявку на оценку токена

* Статус заявки устанавливается в SUBMITTED
* В качестве ролей для работы над заявкое назначается захардкоженный массив [PV_APPRAISER_ROLE, PV_APPRAISER2_ROLE, PV_AUDITOR_ROLE] (Без обращения в контракт Validators)
* Оплачивается комиссия в ETH или GALT
* Всем назначенным ролям назначается статус PENDING

## Интерфейс для валидаторов
#### #lockApplication()
Валидатор с указанной ролью блокирует за собой право на рассмотрение заявки

* Метод доступен только для заявок в статусе SUBMITTED, VALUATED, REVERTED, CONFIRMED
* Метод доступен только для ролей в статусе PENDING
* Статус заявки не меняется
* Статус роли переходит в LOCKED

#### #valuatePlot()
Валидатор с ролью `оценщик` первоначально оценивает стоимость участка в GALT токенах

* Метод доступен только для заявок в статусе SUBMITTED либо REVERTED
* Метод доступен только для ролей в статусе LOCKED
* Статус заявки меняется на VALUATED

#### #valuatePlot2()
Валидатор с ролью `контролер - оценщик` проверяет оценку первого оценщика

* Метод доступен только для заявок в статусе VALUATED
* Метод доступен только для ролей в статусе LOCKED
* Если оценки первого и текущего оценщиков совпадают, статус заявки меняется на CONFIRMED
* Если оценки не совпадают, статус заявки меняется на REVERTED

#### #approveValuation()
Валидатор с ролью `аудитор` может одобрить заявки в случае

* Метод доступен только для заявок в статусе CONFIRMED
* Метод доступен только для ролей в статусе LOCKED
* Метод доступен только в случае, если оценки первого и текущего оценщиков совпадают
* Статус заявки меняется на APPROVED
* Обновляется запись в реестре оценок для текущего токена упаковки
* Валидаторы могут забрать свои вознаграждения
* GaltSpace может забрать свое вознаграждение

#### #claimValidatorReward()
Валидатор забирает свое вознаграждение

* Метод доступен только для заявок в статусе APPROVED
* В зависимости от типа заявки, на адрес валидатора перечисляются либо ETH либо GALT
* Поставляется флаг, что валидатор на данной роли получил вознаграждение
* Статус заявки не изменяется

## Сценарий UI 1: Создание заявки на оценку стоимости земельного участка.
0. Оценка стоимости участка необходима для того, чтобы зафиксировать стоимость для последующей продажи через DEX. Это необходимо сделать до любых регистрационных действий.
1. После того, как токен Земельного участка был создан пользователь может сделать оценку стоимости земельного участка в токенах GALT. Так как токены GALT имеют DEX и текущую стоимость, то эта оценка возможна.
2. Пользователь в меню Мои участки в меню Участка может нажать кнопку "Отправить на оценку". Появится окно для ввода следуюших параметров.

|Параметр|Значение по умолчанию|Тип|
|--------|--------|---------|
|ID Участка|Берется по выбранному участку, не редактируется|uint256|
|Селектор оплаты комиссии|GALT, меняется на ETH|Селектор|
|Поле для ввода комиссии|Минимальное значение комиссии|float|
|Рекомендуемая комиссия|Рассчитанная рекомендуемая комиссия|float|
|Поле для загрузки Описания, фотографий и документов по участку|||

3. Пользователь нажимает кнопку "Подтвердить". Создается транзакция с вызовом метода контракта PlotCustodianManagement. Метод создает заявку по оценке стоимости участка. Все загруженные файлы записываются в IPFS и записываются в заявку. Комиссия оплачивается.

## Сценарий UI 2: Выполнение оценки стоимости земельного участка
1. Оценку стоимости производят Роли: Оценщик, Контроллер - Оценщик, Аудитор.
2. В меню "Заявки на оценку" каждая из этих ролей может нажать на кнопку "Закрепить заявку".
3. Оценщик может посмотреть всю информацию по участк, включая заявку по которой тот был зарегистрирован и документы в IPFS. После этого он нажимает кнопку "Сделать оценку" и вводит стоимость участка в токенах GALT. Нажимает подтвердить, создается транзакция с методом PlotCustodianManagement и оценка записывается в заявку.
4. После того, как оценка была записана в заявку Контроллер - Оценщик должен указать ту же самую сумму или изменить ее. Если сумма была изменена, то заявка возвращается Оценщику. 
5. Если сумма совпадает, то Аудитор может подписать транзакцию. Статус заявки становится Выполнена, сумма финальной оценки вместе с таймстампом фиксируется в контракте.
6. Нужно предусмотреть дополнительные механизмы точности оценки и отсутствия мошенничества.
